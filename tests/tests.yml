---
- name: Get keystone cluster ip
  shell:
    cmd: |
      kubectl get service keystone --namespace {{namespace}} --template={%raw%}{{.spec.clusterIP}}{%endraw%}
    executable: /bin/bash
  register: keystone_ip

- set_fact:
    keystone_ip: "{{keystone_ip.stdout}}"

- name: Test DNS with busybox
  shell:
    cmd: |
      cat <<EOF | kubectl create -f -
      apiVersion: v1
      kind: Pod
      metadata:
        name: busybox
        namespace: {{namespace}}
      spec:
        containers:
        - image: busybox
          command:
            - sleep
            - "3600"
          imagePullPolicy: IfNotPresent
          name: busybox
        restartPolicy: Always
      EOF

      kubectl exec --namespace {{namespace}} -ti busybox -- nslookup kubernetes.default
      kubectl exec --namespace {{namespace}} -ti busybox -- nslookup mariadb
      kubectl exec --namespace {{namespace}} -ti busybox -- nslookup keystone
      kubectl exec --namespace {{namespace}} -ti busybox -- ping -c 4 mariadb
      kubectl exec --namespace {{namespace}} -ti busybox -- ping -c 4 keystone

      kubectl get service keystone --namespace {{namespace}} --template={%raw%}{{.spec.clusterIP}}{%endraw%}
    executable: /bin/bash
  register: busybox_output

- debug:
    msg: "{{busybox_output.stdout}}"

- name: Wait for keystone to become available
  wait_for:
    host: "{{keystone_ip}}"
    port: "{{item}}"
    delay: 2
    timeout: 300
  with_items:
    - 35357
    - 5000

- name: Copy tempests config
  become: true
  template:
    src: templates/tempest.conf
    dest: /etc/tempest/tempest.conf

- name: Run tempest
  shell:
    cmd: |
      set -x
      set -e
      tempest init tempest
      cd tempest
      tempest run -r identity
    executable: /bin/bash
  register: tempest_output
