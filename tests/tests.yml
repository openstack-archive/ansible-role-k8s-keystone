---
- name: Get keystone cluster ip
  shell:
    cmd: |
      kubectl get service keystone --namespace {{namespace}} --template={%raw%}{{.spec.clusterIP}}{%endraw%}
    executable: /bin/bash
  register: keystone_ip

- set_fact:
    keystone_ip: {{keystone_ip.stdout}}

- name: Wait for keystone to become available
  wait_for:
    host={{keystone_ip}}
    port=35357
    delay=2
    timeout=300

- name: Copy tempests config
  become: true
  template:
    src: templates/tempest.conf
    dest: /etc/tempest.conf

- name: Run tempest
  shell:
    cmd: |
      tempest --config-file /etc/tempest.conf
    executable: /bin/bash
  register: tempest_output
