---
- name: Get keystone cluster ip
  shell:
    cmd: |
      kubectl get service keystone --namespace {{namespace}} --template={%raw%}{{.spec.clusterIP}}{%endraw%}
    executable: /bin/bash
  register: keystone_ip

- set_fact:
    keystone_ip: "{{keystone_ip.stdout}}"

- name: Wait for keystone to become available
  wait_for:
    host: "{{keystone_ip}}"
    port: "{{item}}"
    delay: 2
    timeout: 300
  with_items:
    - 35357
    - 5000

- name: Test keystone jobs completion
  shell:
    cmd: |
      set -ex
      ls -la /tmp

      rst=$(kubectl --namespace {{namespace}} get jobs {{item}} --template={%raw%}"{{.status.succeeded}}"{%endraw%})
      if [ "$rst" == "1" ]; then
          exit 0
      fi
      exit 1
    executable: /bin/bash
  retries: 6
  delay: 5
  register: task_result
  until: task_result.rc == 0
  with_items:
    - keystone-createdb
    - keystone-db-sync
    - keystone-fernet
    - keystone-bootstrap


- name: Copy tempests config
  become: true
  template:
    src: templates/tempest.conf
    dest: /etc/tempest/tempest.conf

- name: Run tempest
  shell:
    cmd: |
      set -x
      set -e
      tempest init tempest
      cd tempest
      tempest run -r identity
    executable: /bin/bash
  register: tempest_output
